<!doctype html><html lang=en><head><meta charset=utf-8><title>Serverless NEG を試す ~Cloud RUN, App Engine, Cloud Functions の準備~</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXX-XX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-XXXXXXXX-XX');</script><script data-goatcounter=https://iganari.github.io/count async src=//iganari.github.io/count.js></script><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://iganari.github.io/index.xml title="Escape from"><meta name=twitter:card content="summary"><meta name=twitter:title content="Serverless NEG を試す ~Cloud RUN, App Engine, Cloud Functions の準備~"><meta name=twitter:description content="2020/07 時点での Serverless NEG のハンズオン資料です。
複数の記事に跨って作成しており、2番目の記事になります。"><link rel=stylesheet href=https://iganari.github.io/fontawesome/css/all.min.css><link id=dark-mode-theme rel=stylesheet href=https://iganari.github.io/css/dark.css><script>var darkTheme=document.getElementById('dark-mode-theme')
var storedTheme=localStorage.getItem('dark-mode-storage')
if(storedTheme==='dark'){darkTheme.disabled=false}else if(storedTheme==='light'){darkTheme.disabled=true}</script><script src=https://iganari.github.io/js/bundle.js></script><script src=https://iganari.github.io/js/instantpage.min.js type=module defer></script><meta name=generator content="Hugo 0.79.1"></head><body><header><nav class=navbar><div class=nav><a href=https://iganari.github.io/ class=nav-logo><img src=https://iganari.github.io/images/icon.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/about/ id=About><em class="fas fa-user fa-lg"></em></a></li><li><a href=/tags id=Tags><em class="fas fa-tag fa-lg"></em></a></li><li><a href=/categories id=Category><em class="fas fa-folder-open fa-lg"></em></a></li><li><a href=/search id=Search><em class="fas fa-search fa-lg"></em></a></li><li><a href=/archives id=Archives><em class="fas fa-archive fa-lg"></em></a></li></ul></div></nav><div class=intro-header><div class=container><div class=post-heading><h1>Serverless NEG を試す ~Cloud RUN, App Engine, Cloud Functions の準備~</h1><span class=meta-post><em class="fa fa-calendar-alt"></em>&nbsp;Jul 27, 2020</span></div></div></div></header><div class=container role=main><article class=article class=blog-post><p>2020/07 時点での Serverless NEG のハンズオン資料です。</p><p>複数の記事に跨って作成しており、2番目の記事になります。</p><hr><h1 id=構成>構成</h1><p>この記事の内容は長いため複数の記事に跨って作成しています。</p><p>適宜、興味のある記事を参照して下さい。</p><ul><li><a href=https://iganari.github.io/blog/2020-07-27_try-serverless-neg-00/>Serverless NEG とは?</a></li><li>&lt;本記事> <a href=https://iganari.github.io/blog/2020-07-27_try-serverless-neg-01/>Cloud RUN, App Engine, Cloud Functions の準備</a></li><li><a href=https://iganari.github.io/blog/2020-07-27_try-serverless-neg-02/>サブドメインの設定</a></li><li><a href=https://iganari.github.io/blog/2020-07-27_try-serverless-neg-03/>External HTTP(S) Load Balancer の作成</a></li><li><a href=https://iganari.github.io/blog/2020-07-27_try-serverless-neg-04/>リソースの削除</a></li></ul><h1 id=事前準備>事前準備</h1><ul><li>GCP との認証をします。</li></ul><pre><code>gcloud auth login -q
</code></pre><ul><li>GCP コマンドのため、環境変数を設定しておきます。</li></ul><pre><code>### New Setting
export _pj_id='Your GCP Project ID'
export _common='check-serverless-neg'
</code></pre><ul><li>GCP Project の設定をしておきます。</li></ul><pre><code>gcloud config set project ${_pj_id}
</code></pre><ul><li>サンプルコードをダウンロードし、本記事のサンプルコードが格納しているディレクトリに移動します。</li></ul><pre><code>cd [Your WorkSpace]
git clone https://github.com/iganari/package-gcp.git
cd package-gcp/compute/networkendpointgroups/serverless
</code></pre><h1 id=やること>やること</h1><ul><li>Serverless NEG の backend に設定する Cloud RUN, App Engine, Cloud Functions の準備をします。</li></ul><h1 id=cloud-run-のサンプルの準備>Cloud Run のサンプルの準備</h1><ul><li>Cloud Run のサンプルコードがあるディレクトリに移動します。</li></ul><pre><code>cd cloudrun
</code></pre><ul><li>Cloud Run 上で使用するコンテナイメージを Google Container Registry (GCR) にデプロイします。</li></ul><pre><code>gcloud builds submit --tag gcr.io/${_pj_id}/${_common}-run
</code></pre><ul><li>Cloud Run をデプロイします。</li></ul><pre><code>gcloud run deploy ${_common}-run \
    --image gcr.io/${_pj_id}/${_common}-run \
    --platform managed \
    --region asia-northeast1 \
    --allow-unauthenticated
</code></pre><pre><code>### 例

# gcloud run deploy ${_common}-run \
&gt;     --image gcr.io/${_pj_id}/${_common}-run \
&gt;     --platform managed \
&gt;     --region asia-northeast1 \
&gt;     --allow-unauthenticated
Deploying container to Cloud Run service [check-serverless-neg-run] in project [~~~~~~~~~~] region [asia-northeast1]
✓ Deploying new service... Done.
  ✓ Creating Revision...
  ✓ Routing traffic...
  ✓ Setting IAM Policy...
Done.
Service [check-serverless-neg-run] revision [check-serverless-neg-run-00001-lut] has been deployed and is serving 100 percent of traffic at https://check-serverless-neg-run-3umtulj4sq-an.a.run.app
</code></pre><ul><li>Web ブラウザで確認します。<ul><li>上述のデプロイコマンドの出力結果に以下の URL が出力されています。</li><li><a href=https://check-serverless-neg-run-3umtulj4sq-an.a.run.app>https://check-serverless-neg-run-3umtulj4sq-an.a.run.app</a></li></ul></li></ul><figure><img src=/images/2020/07/try-serverless-neg_sample-run.png></figure><ul><li>ルートディレクトリに戻ります。</li></ul><pre><code>cd -
</code></pre><h1 id=app-engine-のサンプルの準備>App Engine のサンプルの準備</h1><ul><li>App Engine のサンプルコードがあるディレクトリに移動します。</li></ul><pre><code>cd appengine
</code></pre><ul><li>サンプルから app.yaml を作成します。</li></ul><pre><code>cat app.yaml.sample | sed &quot;s/YOUR_SERVICE/${_common}-app/g&quot; &gt; app.yaml
</code></pre><ul><li>App Engine にアプリをデプロイします。</li></ul><pre><code>gcloud app deploy
</code></pre><ul><li>デプロイしたアプリの URL を確認します。</li></ul><pre><code>gcloud app browse -s ${_common}-app
</code></pre><pre><code>### 例

# gcloud app browse -s ${_common}-app
Did not detect your browser. Go to this link to view your app:
https://check-serverless-neg-app-dot-[~~~~~~~~~~].an.r.appspot.com
</code></pre><ul><li>Web ブラウザで確認します。<ul><li>上述のデプロイコマンドの出力結果に以下の URL が出力されています。</li><li>https://check-serverless-neg-app-dot-[~~~~~~~~~~].an.r.appspot.com</li></ul></li></ul><figure><img src=/images/2020/07/try-serverless-neg_sample-app.png></figure><ul><li>ルートディレクトリに戻ります。</li></ul><pre><code>cd -
</code></pre><h1 id=cloud-functions-のサンプルの準備>Cloud Functions のサンプルの準備</h1><pre><code>cd functions
</code></pre><pre><code>gcloud functions deploy func \
  --runtime python38 \
  --trigger-http \
  --region asia-northeast1 \
  --allow-unauthenticated
</code></pre><ul><li>Web ブラウザで確認します。<ul><li>GCP コンソールから、Functions の URL を確認することが出来ます。</li><li>https://check-serverless-neg-app-dot-[~~~~~~~~~~].an.r.appspot.com</li></ul></li></ul><figure><img src=/images/2020/07/try-serverless-neg_sample-func.png></figure><ul><li>ルートディレクトリに戻ります。</li></ul><pre><code>cd -
</code></pre><h1 id=まとめ>まとめ</h1><p>これで Serverless NEG の backend に設定する Cloud RUN, App Engine, Cloud Functions の準備が出来ました!!</p><p>次は <a href=https://iganari.github.io/blog/2020-07-27_try-serverless-neg-02/>サブドメインの設定</a> をやっていきます!</p><p>Have fun! :)</p></article><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='yourdisqusshortname';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><footer><div><a href=https://twitter.com/iganari_ name=twitter><em class="fab fa-twitter"></em></a><a href=https://github.com/iganari name=github><em class="fab fa-github"></em></a><a href=https://www.linkedin.com/in/iganari/ name=LinkedIn><em class="fab fa-linkedin-in"></em></a><a href=link%20to%20social%20media name="name of social media"><em class="A icon from https://fontawesome.com/"></em></a><div class=container><p class="credits copyright"><a href=https://iganari.github.io/about>iganari</a>
&nbsp;&copy;
2021
&nbsp;/&nbsp;
<a href=https://iganari.github.io/>Escape from</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>